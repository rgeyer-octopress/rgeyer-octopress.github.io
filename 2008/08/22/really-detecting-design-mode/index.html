<h2>date: 2008-08-22 00:00:00 -0700</h2>

<p>layout: post
title: Really Detecting Design Mode
comments: true
categories:
&ndash; C# coding
tags:
&ndash; linkedin
status: publish
type: post
published: true
meta:
  <em>edit_last: &lsquo;1&rsquo;
  </em>sexybookmarks_shortUrl: <a href="http://bit.ly/cdzwxx">http://bit.ly/cdzwxx</a>
  _sexybookmarks_permaHash: b1d518eb4e3e9cdee59fdb8ae68036af</p>

<h2>date: 2008-08-22 00:00:00 -0700</h2>

<p>I recently had to deal with the problem of ADO.NET data access occurring on user controls, and forms in the Visual Studio design view.  Now the data access depended upon a connection string in the App.config file and consequently, when run from Visual Studio it could not connect to the database since the connection string wasn&rsquo;t available.</p>

<p>So, I proceeded to do some searching on the problem.  I very quickly discovered the <a href="http://msdn.microsoft.com/en-us/library/system.componentmodel.component.designmode.aspx">DesignMode</a> flag for components, and thought I&rsquo;d found my solution.</p>

<p>I promptly added the following to the UserControl that was blowing up when I opened it in the Designer.</p>

<pre lang="csharp" line="1">
public UserControlCtor()
{
     InitializeComponent();
     if(!DesignMode)
     {
          // Do the data access here.
     }
}
</pre>


<p>I quickly discovered however, that the DesignMode flag wasn&rsquo;t set until AFTER the constructor had run, and the parent object set the DesignMode flag on this control.  Okay, simple enough we just move it to the OnLoad event for the UserControl right?  Well, yes that would probably work in most cases however in our application this practice of doing data access in the constructors was rampant and therefore the dozen or so UserControls that were placed on this UserControl had the same problem.  I&rsquo;d need to make the this change to&hellip; well&hellip; pretty much every UserControl in the application.  While that&rsquo;s something that should happen, right now we cannot afford the <a href="http://www.martinfowler.com/bliki/TechnicalDebt.html">technical debt</a> to fix it.</p>

<p>Fortunately, all of our ADO.NET access in this application is abstracted into a library class which does all the data access, and handles things like opening and closing/disposing the database connection and just generally insulating users from the complexities of using ADO.NET.  That&rsquo;s the obvious candidate for the best place to filter design or runtime mode and either run the data access or not.</p>

<p>But wait, a helper class in the app won&rsquo;t have a DesignMode flag and besides, how would it get set, you say?  Well, in my travels looking for ways to detect that the code is running in design mode, I stumbled across several solutions.  The most intriguing of which is the <a href="http://msdn.microsoft.com/en-us/library/system.componentmodel.licensemanager.usagemode.aspx">UsageMode</a> flag.  This can be checked in any class at any time and gives you an accurate gauge of what mode your code is running in.</p>

<p>So, in the few methods that do the data access in our ADO.NET abstracting class, I simply do the following.</p>

<pre lang="csharp" line="1">
if(System.ComponentModel.LicenseManager.UsageMode ==
   System.ComponentModel.LicenseUsageMode.Designtime)
     return;
</pre>


<p>This checks to see if we&rsquo;re in design mode or not, and if we are simply bails out of the method effectively skipping the data access and solving our problem.  Pretty cool eh?</p>

<p>I found several suggestions on how to detect design mode, they pretty much consisted of the following.</p>

<ol>
  <li><a href="http://www.euforik.com/blog/post/2008/07/Knowing-if-youre-in-design-mode.aspx">Check the DesignMode Flag</a>
  </li>
  <li><a href="http://devintelligence.com/blogs/netadventures/archive/2005/04/29/620.aspx">Check if the current process is Visual Studio</a>
  </li>
  <li><a href="http://www.devnewsgroups.net/group/microsoft.public.dotnet.framework.windowsforms/topic4403.aspx">Check the UsageMode Flag</a>
  </li>
</ol>

