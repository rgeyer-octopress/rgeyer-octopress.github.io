
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Grails Domain Mocking Limitations - Ryans Octopress Blog</title>
  <meta name="author" content="Ryan J. Geyer">

  
  <meta name="description" content="So, I just threw out most of this morning trying to figure out why something which clearly should work was blowing up my unit test on a grails app. &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://rgeyer-octopress.github.io/blog/2010/07/27/grails-domain-mocking-limitations">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Ryans Octopress Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-2840005-7']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Ryans Octopress Blog</a></h1>
  
    <h2>Testing out Ocotopress to replace my Wordpress blog</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:rgeyer-octopress.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Grails Domain Mocking Limitations</h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-07-27T00:00:00-07:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


<div class="entry-content">So, I just threw out most of this morning trying to figure out why something which clearly <em>should</em> work was blowing up my unit test on a grails app.  To spare you the same pain I&#8217;m documenting it here.

The scenario is that I have Roles and Privileges as domain classes.  A role has many privileges, and any privilege may belong to one or more roles.  This is represented in domain classes pretty succinctly as;

<p class="filename">/grails-app/domain/com/nslms/mockdomainlimtations/Role.groovy</p>
[groovy]
package com.nslms.mockdomainlimitations

class Role {
  static hasMany = [privileges: Privilege]

  static constraints = {
  }
  String name
}
[/groovy]

<p class="filename">/grails-app/domain/com/nslms/mockdomainlimtations/Privilege.groovy</p>
[groovy]
package com.nslms.mockdomainlimitations

class Privilege {

  static constraints = {
  }

  String name
}
[/groovy]

So I can access all the privileges which belong to a role pretty easily, but what if I want to know all roles which a particular privilege belongs to?  Easy enough, we can look that up in a variety of ways.  Below I show adding a new closure to the privilege domain class which uses the <a href="http://grails.org/doc/latest/ref/Domain%20Classes/withCriteria.html">withCriteria</a> functionality of GORM to return all roles which have this privilege in the privileges map.  The new closure is in the highlighted lines.

<p class="filename">/grails-app/domain/com/nslms/mockdomainlimtations/Privilege.groovy (with new closure)</p>
[groovy highlight=&#8221;10,11,12,13,14,15,16&#8221;]
package com.nslms.mockdomainlimitations

class Privilege {

  static constraints = {
  }

  String name

  def getRolesWithThisPrivilege = {
    Role.withCriteria() {
      privileges {
        eq(&#8216;id&#8217;, this.id)
      }
    }
  }
}
[/groovy]

Now, if you&#8217;re doing proper test driven development (you are doing TDD, right?!), you&#8217;d probably already have a test written for this new closure that would look something like the highlighted lines of the test fixture below.  Notice lines 8 and 9 which are also highlighted to show that we&#8217;re asking the framework to mock out the GORM methods on the role and privilege classes.

<p class="filename">/test/unit/com/nslms/mockdomainlimitaions/PrivilegeTests.groovy</p>
[groovy highlight=&#8221;8,9,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32&#8221;]
package com.nslms.mockdomainlimitations

import grails.test.*

class PrivilegeTests extends GrailsUnitTestCase {
  protected void setUp() {
    super.setUp()
    MockUtils.mockDomain(Role.class)
    MockUtils.mockDomain(Privilege.class)
  }

  protected void tearDown() {
    super.tearDown()
  }

  void testAbilityToGetAListOfRolesAPrivilegeBelongsTo() {
    def role1 = new Role(name: &#8216;Administrator&#8217;)
    def role2 = new Role(name: &#8216;User&#8217;)

    def priv1 = new Privilege(name: &#8216;ReadAll&#8217;).save(flush: true)

    role1.addToPrivileges(priv1)
    role2.addToPrivileges(priv1)

    role1.save(flush: true)
    role2.save(flush: true)

    def roleList = priv1.getRolesWithThisPrivilege()

    assert roleList.size() == 2
    assert roleList == [role1, role2]
  }
}
[/groovy]

Even after you&#8217;ve implemented <b>getRolesWithThisPrivilege</b> on the Privileges domain class though, you&#8217;ll find your test still fails with an error that looks like the following.

<p style="font-size: larger; font-style: italic; color: red;">No signature of method: com.nslms.mockdomainlimitations.Role.withCriteria() is applicable for argument types: (com.nslms.mockdomainlimitations.Privilege$_closure1_closure3) values: [com.nslms.mockdomainlimitations.Privilege$_closure1_closure3@8327473]</p>

In short, it&#8217;s telling us that the <a href="http://grails.org/doc/latest/ref/Domain%20Classes/withCriteria.html">withCriteria</a> method of GORM isn&#8217;t implemented in the context of our test.  Of course if you put the exact same code in an integration test you&#8217;re golden.

<p class="filename">/test/integration/com/nslms/mockdomainlimitations/PrivilegeTest.groovy</p>
[groovy]
package com.nslms.mockdomainlimitations

class PrivilegeTest extends GroovyTestCase {
  void testAbilityToGetAListOfRolesAPrivilegeBelongsTo() {
    def role1 = new Role(name: &#8216;Administrator&#8217;)
    def role2 = new Role(name: &#8216;User&#8217;)

    def priv1 = new Privilege(name: &#8216;ReadAll&#8217;).save(flush: true)

    role1.addToPrivileges(priv1)
    role2.addToPrivileges(priv1)

    role1.save(flush: true)
    role2.save(flush: true)

    def roleList = priv1.getRolesWithThisPrivilege()

    assert roleList.size() == 2
    assert roleList == [role1, role2]
  }
}
[/groovy]

With this in place, you can run a &#8220;grails test-app -integration&#8221; and the exact same test which failed during unit testing will succeed.  This is of course because the entire grails bootstrapping occurs, and all of the artifacts (like domain classes) are wired up fully by the framework.

So the moral of the story?  If you&#8217;re planning to test anything more than simple saves with GORM in your testing phase, consider putting the more complex stuff into an integration test.  Either that, or keep your eyes peeled for problems like this and be prepared to refactor.

Feel free to grab a copy of the test grails app I created for this example.

<del datetime="2010-12-26T23:15:20+00:00">svn export https://linode.nslms.com/svn_ro/MockDomainLimitations</del>

<em><strong><span style="color: #ff0000;">* UPDATE: This example app has a new home..</span></strong></em>
<p>Grab the project</p>
[bash]
git clone git://ec2.nslms.com/grails/blog_example_mock_limitations
[/bash]
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Ryan J. Geyer</span></span>

      








  


<time datetime="2010-07-27T00:00:00-07:00" pubdate data-updated="true"></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/grails-slash-groovy/'>Grails/Groovy</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://rgeyer-octopress.github.io/blog/2010/07/27/grails-domain-mocking-limitations/" data-via="rjgeyer" data-counturl="http://rgeyer-octopress.github.io/blog/2010/07/27/grails-domain-mocking-limitations/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2010/07/20/my-torrid-confession/" title="Previous Post: My torrid confession...">&laquo; My torrid confession...</a>
      
      
        <a class="basic-alignment right" href="/blog/2010/08/01/sleep-sweet-sweet-sleep/" title="Next Post: Sleep, sweet sweet sleep">Sleep, sweet sweet sleep &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2011/07/02/how-i-vandalized-a-weed-whacker-at-home-depot/">How I Vandalized a Weed Whacker at Home Depot</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/06/27/policy-for-an-s3-only-amazon-iam-user/">Policy for an S3 Only Amazon IAM User</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/06/24/the-baby/">The Baby</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/06/22/potty-training-day-13-no-way/">Potty Training Day 13: NO WAY!</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/06/20/potty-training-day-12-old-hat/">Potty Training Day 12: Old Hat</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/rgeyer">@rgeyer</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'rgeyer',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/+RyanGeyerCycles?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Ryan J. Geyer -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
